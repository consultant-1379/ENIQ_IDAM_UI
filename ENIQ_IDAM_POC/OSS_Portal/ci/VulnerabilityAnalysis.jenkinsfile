pipeline {
  agent {
    node {
      label 'presentation'
    }
  }
  parameters {
    string(name: 'GERRIT_REFSPEC',
      description: 'Gerrit patchset refspec. It is only used if there is change in the ruleset or the Jenkinsfile. The CI chart\'s stage can also be changed with this.')
    string(name: 'HELM_VERSION',
      description: 'The version of the Helm chart that you want to deploy. If unset the newest version is deployed.' +
      'The available versions are listed here: https://arm.epk.ericsson.se/artifactory/proj-eea-drop-helm/eric-adp-gui-aggregator-service/')
    string(name: 'ADDITIONAL_JIRA_MANAGER_PARAMS', defaultValue: '--severity-blacklist "Medium, Low, Informational, info"',
      description: 'Additional parameters for the Jira management tool. Only used if MANAGE_JIRA is set to true.')
    booleanParam(name: 'UPLOAD_VHUB', defaultValue: false, description: 'Enable vulnerability hub upload (Only ADP general and re-usable services can do that!!)')
    booleanParam(name: 'UPLOAD_ARM', defaultValue: false, description: 'Enable ARM upload (upload every VA scan tool reports and the VA report markdown as well)')
    booleanParam(name: 'UPLOAD_ERIDOC', defaultValue: false, description: 'Enable ERIDOC upload (upload VA report markdown to the ERIDOC)')
    booleanParam(name: 'MANAGE_JIRA', defaultValue: false, description: 'Enable automatic Jira Vulnerability card management')
  }
  options {
    ansiColor('xterm')
    timeout(time: 1, unit: 'HOURS')
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30'))
  }
  stages {
    stage('Prepare') {
      steps {
        sh 'bob -r ci/rulesets/va-rules.yaml --dryrun $(bob -r ci/rulesets/va-rules.yaml -lq)'
      }
    }
    stage('Cleanup bob') {
      steps {
        sh 'bob clean'
      }
    }
    stage('Init') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'ARM_API_TOKEN')]) {
          ansiColor('xterm') {
            sh 'bob -r ci/rulesets/va-rules.yaml init'
          }
        }
      }
    }
    stage('Run Image scans and Install') {
      parallel {
        stage('K8S Install') {
          steps {
            lock(resource: null, label: 'presentation-ci', quantity: 1, variable: 'system') {
              withCredentials([
                usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD'),
                usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'ARM_API_TOKEN'),
                file(credentialsId: env.system, variable: 'KUBECONFIG')
              ]) {
                ansiColor('xterm') {
                  sh 'bob -r ci/rulesets/va-rules.yaml deploy-chart'
                }
              }
            }
          }
        }
        stage('Anchore') {
          steps {
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
              sh 'bob -r ci/rulesets/va-rules.yaml anchore-scan'
              archiveArtifacts '.bob/reports/anchore/**/*.*'
            }
          }
        }
        stage('Trivy') {
          steps {
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
              sh 'bob -r ci/rulesets/va-rules.yaml trivy-scan'
              archiveArtifacts '.bob/reports/trivy/**/*.*'
            }
          }
        }
        stage('Xray') {
          steps {
            withCredentials([usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'ARM_API_TOKEN')]) {
              sh 'bob -r ci/rulesets/va-rules.yaml fetch-xray-report'
              archiveArtifacts '.bob/reports/xray/**/*.*'
              archiveArtifacts '.bob/reports/xray-raw/**/*.*'
            }
          }
        }
      }
    }
    stage('Cleanup images') {
      steps {
        sh 'bob -r ci/rulesets/va-rules.yaml cleanup'
      }
    }
    stage('ZAP scan') {
      steps {
        // TO pull the adp images, whe have to use the arm-adpgs-eceaart-api-token and the eceaart user, but not the eceaart password
        lock(resource: null, label: 'presentation-ci', quantity: 1, variable: 'system') {
          withCredentials([
            usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'DONTCARE'),
            string(credentialsId: 'arm-adpgs-eceaart-api-token', variable: 'ARM_API_TOKEN'),
            file(credentialsId: env.system, variable: 'KUBECONFIG')
          ]) {
            catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
              sh 'bob -r ci/rulesets/va-rules.yaml zap-scan'
              archiveArtifacts '.bob/reports/zap/**/*.*'
            }
          }
        }
      }
    }
    stage('Nmap scan') {
      steps {
        // TO pull the adp images, whe have to use the arm-adpgs-eceaart-api-token and the eceaart user, but not the eceaart password
        lock(resource: null, label: 'presentation-ci', quantity: 1, variable: 'system') {
          withCredentials([
            usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'DONTCARE'),
            string(credentialsId: 'arm-adpgs-eceaart-api-token', variable: 'ARM_API_TOKEN'),
            file(credentialsId: env.system, variable: 'KUBECONFIG')
          ]) {
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
              sh 'bob -r ci/rulesets/va-rules.yaml nmap-scan'
              archiveArtifacts '.bob/reports/nmap/**/*.*'
            }
          }
        }
      }
    }
    // stage('CIS-CAT scan') {
    //   steps {
    //     // TO pull the adp images, whe have to use the arm-adpgs-eceaart-api-token and the eceaart user, but not the eceaart password
    //     lock(resource: null, label: 'presentation-ci', quantity: 1, variable: 'system') {
    //       withCredentials([
    //         usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'DONTCARE'),
    //         string(credentialsId: 'arm-adpgs-eceaart-api-token', variable: 'ARM_API_TOKEN'),
    //       ]) {
    //         catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
    //           sh 'bob -r ci/rulesets/va-rules.yaml cis-cat-scan'
    //           archiveArtifacts '.bob/reports/cis-cat/**/*.*'
    //         }
    //       }
    //     }
    //   }
    // }
    stage('Namespace Cleanup') {
      steps {
        lock(resource: null, label: 'presentation-ci', quantity: 1, variable: 'system') {
          withCredentials([file(credentialsId: env.system, variable: 'KUBECONFIG')]) {
            ansiColor('xterm') {
              sh 'bob namespace-cleanup'
            }
          }
        }
      }
    }
    stage('Generate and upload VA report') {
      steps {
        withCredentials([string(credentialsId: 'gas-vulnhub-api-token', variable: 'VHUB_TOKEN')]) {
          catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            sh 'bob -r ci/rulesets/va-rules.yaml generate-upload-VA-report'
            archiveArtifacts '.bob/reports/**_va-report.md'
          }
        }
      }
    }
    stage('Generate aggregated vulnerability result') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          sh 'bob -r ci/rulesets/va-rules.yaml generate-aggregated-vuln-list'
          archiveArtifacts '.bob/reports/aggregated-vulns.yaml'
        }
      }
    }
    stage('Manage open Vulnerability Tickets') {
      when { expression { env.MANAGE_JIRA == 'true' } }
      steps {
        withCredentials([string(credentialsId: 'jira-eceaconfl-token', variable: 'JIRA_API_TOKEN')]) {
          catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            script {
              env.MITIGATION_CHANGE_TYPE = sh(
                script:'bob -r ci/rulesets/va-rules.yaml manage-jira-cards',
                returnStatus: true
              )
            }
            archiveArtifacts '.bob/reports/finalized_mitigations.yaml'
          }
        }
      }
    }
    stage('Upload reports to ARM') {
      when { expression { env.UPLOAD_ARM == 'true' } }
      steps {
        withCredentials([usernamePassword(credentialsId: 'arm-functional-user', usernameVariable: 'ARM_API_USER', passwordVariable: 'ARM_API_TOKEN')]) {
          sh 'bob -r ci/rulesets/va-rules.yaml upload-reports-to-arm'
        }
      }
    }
    stage('Upload VA report to Eridoc') {
      when { expression { env.UPLOAD_ERIDOC == 'true' } }
      steps {
        withCredentials([usernamePassword(credentialsId: 'eridoc-username-password', usernameVariable: 'ERIDOC_USERNAME', passwordVariable: 'ERIDOC_PASSWORD')]) {
          sh 'bob -r ci/rulesets/va-rules.yaml upload-va-report-to-eridoc'
        }
      }
    }
    stage('Evaluate the VA status') {
      when {
        allOf {
          expression { env.MANAGE_JIRA == 'true' }
          expression { env.MITIGATION_CHANGE_TYPE == '3' }
        }
      }
      steps {
        sh 'exit 1'
      }
    }
    }
  post {
    always {
      publishHTML(target: [
        allowMissing: false,
        alwaysLinkToLastBuild: false,
        keepAll: true,
        reportDir: '.bob/reports/zap',
        reportFiles: 'backend_api.html',
        reportName: 'WS ZAP Scanning Report'
      ])
      publishHTML(target: [
        allowMissing: false,
        alwaysLinkToLastBuild: false,
        keepAll: true,
        reportDir: '.bob/reports/zap',
        reportFiles: 'ui_api.html',
        reportName: 'UI ZAP Scanning Report'
      ])
      publishHTML(target: [
        allowMissing: false,
        alwaysLinkToLastBuild: false,
        keepAll: true,
        reportDir: '.bob/reports/zap',
        reportFiles: 'ui-logging_api.html',
        reportName: 'UI-Logging ZAP Scanning Report'
      ])
      script {
        if (env.MANAGE_JIRA == 'true') {
          if (env.MITIGATION_CHANGE_TYPE == '1') {
            mail to: 'PDLSCRUMNW@pdl.internal.ericsson.com',
            subject: "New Vulnerabilities found: ${currentBuild.fullDisplayName}",
            body: "Found Vulnerabilities without mitigation: ${env.BUILD_URL}artifact/.bob/reports/finalized_mitigations.yaml"
          } else if (env.MITIGATION_CHANGE_TYPE == '2') {
            mail to: 'PDLSCRUMNW@pdl.internal.ericsson.com',
            subject: "Found Solved Vulnerabilities: ${currentBuild.fullDisplayName}",
            body: "Found Solved Vulnerabilities: ${env.BUILD_URL}artifact/.bob/reports/finalized_mitigations.yaml"
          } else if (env.MITIGATION_CHANGE_TYPE == '3') {
            mail to: 'PDLSCRUMNW@pdl.internal.ericsson.com',
            subject: "VA Pipeline Failed: ${currentBuild.fullDisplayName}",
            body: "Could not complete Jira Action(s): ${env.BUILD_URL}"
          }
        }
      }
    }
    failure {
      mail to: 'f98b007c.ericsson.onmicrosoft.com@emea.teams.ms',
      subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
      body: "Failure on ${env.BUILD_URL}"
    }
  }
  }
